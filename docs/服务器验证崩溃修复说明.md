# æœåŠ¡å™¨éªŒè¯å´©æºƒé—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

**é—®é¢˜**ï¼šåœ¨æ ¡éªŒæœåŠ¡å™¨çš„æ—¶å€™å‘ç”Ÿå´©æºƒ

## é—®é¢˜åˆ†æ

æœåŠ¡å™¨éªŒè¯è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿå´©æºƒçš„åŸå› ï¼š

1. **JSONè§£æé”™è¯¯**ï¼šæœåŠ¡å™¨å“åº”æ ¼å¼ä¸æ­£ç¡®æˆ–æŸå
2. **ç½‘ç»œå¼‚å¸¸æœªå¤„ç†**ï¼šè¿æ¥è¶…æ—¶ã€æ–­å¼€ã€æ‹’ç»ç­‰å¼‚å¸¸æƒ…å†µ
3. **å¯†é’¥æ“ä½œå¼‚å¸¸**ï¼šRSAå¯†é’¥å¯¼å…¥ã€åŠ å¯†è§£å¯†è¿‡ç¨‹ä¸­çš„é”™è¯¯
4. **æ•°æ®æ ¼å¼éªŒè¯ç¼ºå¤±**ï¼šæœªéªŒè¯æ¶ˆæ¯é•¿åº¦ã€æ•°æ®ç±»å‹ç­‰
5. **èµ„æºæ¸…ç†ä¸å½“**ï¼šå¼‚å¸¸æ—¶socketæœªæ­£ç¡®å…³é—­
6. **å¼‚æ­¥æ“ä½œç«æ€**ï¼šçº¿ç¨‹åœæ­¢æ ‡å¿—æ£€æŸ¥ä¸å……åˆ†

## ä¿®å¤æ–¹æ¡ˆ

### 1. ConnectThreadéªŒè¯è¿‡ç¨‹åŠ å›º

#### æ— åŠ å¯†æ¨¡å¼éªŒè¯
```python
try:
    # å‘é€éªŒè¯è¯·æ±‚
    verify_payload = {"command": "verify", "payload": "cat-message-v2.0-noenc"}
    send_message_with_length(client_socket, json.dumps(verify_payload).encode('utf-8'))
    
    # å®‰å…¨çš„å“åº”å¤„ç†
    response = read_message(client_socket)
    if not response or self._stop_flag:
        raise Exception("æœªæ”¶åˆ°æœåŠ¡å™¨å“åº”")
    
    # å®‰å…¨çš„JSONè§£æ
    try:
        response_data = json.loads(response.decode('utf-8'))
    except (json.JSONDecodeError, UnicodeDecodeError) as e:
        raise Exception(f"æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯: {str(e)}")
    
    # æ•°æ®ç±»å‹éªŒè¯
    if not isinstance(response_data, dict):
        raise Exception("æœåŠ¡å™¨å“åº”æ ¼å¼æ— æ•ˆ")
        
except Exception as e:
    # èµ„æºæ¸…ç†
    if client_socket:
        try:
            client_socket.close()
        except:
            pass
    raise Exception(f"æ— åŠ å¯†æ¨¡å¼éªŒè¯å¤±è´¥: {str(e)}")
```

#### åŠ å¯†æ¨¡å¼éªŒè¯
```python
try:
    # å¯†é’¥ç”Ÿæˆå®‰å…¨æ£€æŸ¥
    if self.encryption_mode not in {"RSA2048": 2048, "RSA4096": 4096, "RSA8192": 8192}:
        raise Exception(f"ä¸æ”¯æŒçš„åŠ å¯†æ¨¡å¼: {self.encryption_mode}")
    
    # å…¬é’¥éªŒè¯
    if "public_key" not in response_data:
        raise Exception("æœåŠ¡å™¨æœªæä¾›å…¬é’¥")
    
    # å®‰å…¨çš„å¯†é’¥å¯¼å…¥
    try:
        server_public_key_data = base64.b64decode(response_data["public_key"])
        crypto.import_peer_public_key(server_public_key_data)
    except Exception as e:
        raise Exception(f"æœåŠ¡å™¨å…¬é’¥å¯¼å…¥å¤±è´¥: {str(e)}")
        
except Exception as e:
    # èµ„æºæ¸…ç†å’Œé”™è¯¯ä¼ æ’­
    if client_socket:
        try:
            client_socket.close()
        except:
            pass
    raise Exception(f"åŠ å¯†æ¨¡å¼éªŒè¯å¤±è´¥: {str(e)}")
```

### 2. ç½‘ç»œæ“ä½œå‡½æ•°åŠ å›º

#### read_messageå‡½æ•°
- âœ… **æ·»åŠ 30ç§’è¶…æ—¶æœºåˆ¶**ï¼šé˜²æ­¢æ— é™ç­‰å¾…
- âœ… **æ¶ˆæ¯é•¿åº¦éªŒè¯**ï¼šæ£€æŸ¥é•¿åº¦åˆç†æ€§ï¼ˆ0 < length <= 50MBï¼‰
- âœ… **åˆ†å—è¯»å–ä¼˜åŒ–**ï¼šç¡®ä¿å®Œæ•´æ¥æ”¶æ•°æ®
- âœ… **è¯¦ç»†é”™è¯¯æŠ¥å‘Š**ï¼šåŒºåˆ†è¶…æ—¶ã€ç½‘ç»œé”™è¯¯ç­‰

#### send_message_with_lengthå‡½æ•°
- âœ… **æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥**ï¼šé˜²æ­¢å‘é€ç©ºæ•°æ®
- âœ… **å¤§å°é™åˆ¶éªŒè¯**ï¼šé˜²æ­¢å‘é€è¿‡å¤§æ•°æ®
- âœ… **å‘é€è¶…æ—¶è®¾ç½®**ï¼š30ç§’å‘é€è¶…æ—¶
- âœ… **å¼‚å¸¸åˆ†ç±»å¤„ç†**ï¼šåŒºåˆ†è¶…æ—¶å’Œç½‘ç»œé”™è¯¯

### 3. RSAåŠ å¯†ç±»å®‰å…¨å¢å¼º

#### å¯†é’¥å¯¼å…¥éªŒè¯
```python
def import_peer_public_key(self, key_data):
    try:
        if not key_data:
            raise Exception("å…¬é’¥æ•°æ®ä¸ºç©º")
        
        self.peer_public_key = RSA.import_key(key_data)
        
        # å®‰å…¨éªŒè¯ï¼šç¡®ä¿æ˜¯å…¬é’¥è€Œéç§é’¥
        if self.peer_public_key.has_private():
            raise Exception("å¯¼å…¥çš„æ•°æ®åŒ…å«ç§é’¥ï¼Œå®‰å…¨é£é™©")
            
    except ValueError as e:
        raise Exception(f"å…¬é’¥æ ¼å¼æ— æ•ˆ: {str(e)}")
```

#### åŠ å¯†è§£å¯†å®‰å…¨æ£€æŸ¥
- âœ… **æ•°æ®å­˜åœ¨æ€§æ£€æŸ¥**ï¼šé˜²æ­¢ç©ºæ•°æ®æ“ä½œ
- âœ… **æ•°æ®å¤§å°éªŒè¯**ï¼šRSAåŠ å¯†æ•°æ®å¤§å°é™åˆ¶
- âœ… **å¯†é’¥çŠ¶æ€éªŒè¯**ï¼šç¡®ä¿å¯†é’¥å·²æ­£ç¡®è®¾ç½®
- âœ… **è¯¦ç»†é”™è¯¯åˆ†ç±»**ï¼šåŒºåˆ†æ ¼å¼é”™è¯¯ã€è§£å¯†é”™è¯¯ç­‰

### 4. å¼‚å¸¸åˆ†ç±»å¤„ç†

#### ç½‘ç»œå¼‚å¸¸åˆ†ç±»
```python
except socket.timeout:
    self.connection_error.emit("è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®")
except socket.gaierror as e:
    self.connection_error.emit(f"åŸŸåè§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€: {str(e)}")
except ConnectionRefusedError:
    self.connection_error.emit("è¿æ¥è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œæˆ–ç«¯å£æ˜¯å¦æ­£ç¡®")
except Exception as e:
    if "éªŒè¯å¤±è´¥" in error_msg or "æ ¼å¼é”™è¯¯" in error_msg:
        self.connection_error.emit(f"æœåŠ¡å™¨éªŒè¯é”™è¯¯:\n{error_msg}")
    else:
        self.connection_error.emit(f"è¿æ¥æœåŠ¡å™¨æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯:\n{error_msg}")
```

### 5. ç”¨æˆ·ä½“éªŒæ”¹è¿›

#### è¯¦ç»†çŠ¶æ€æŠ¥å‘Š
- âœ… **è¿æ¥è¿‡ç¨‹å¯è§†åŒ–**ï¼šæ˜¾ç¤º"æ­£åœ¨éªŒè¯æœåŠ¡å™¨..."ç­‰çŠ¶æ€
- âœ… **é”™è¯¯ä¿¡æ¯å±•ç¤º**ï¼šåœ¨èŠå¤©åŒºåŸŸæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
- âœ… **æˆåŠŸè¿æ¥ç¡®è®¤**ï¼šæ˜¾ç¤ºåŠ å¯†æ¨¡å¼ç­‰è¿æ¥ä¿¡æ¯
- âœ… **è°ƒè¯•ä¿¡æ¯è¾“å‡º**ï¼šä¾¿äºé—®é¢˜è¯Šæ–­

#### èµ„æºç®¡ç†ä¼˜åŒ–
- âœ… **è‡ªåŠ¨èµ„æºæ¸…ç†**ï¼šå¼‚å¸¸æ—¶è‡ªåŠ¨å…³é—­socket
- âœ… **çº¿ç¨‹çŠ¶æ€åŒæ­¥**ï¼šæ­£ç¡®å¤„ç†åœæ­¢æ ‡å¿—
- âœ… **UIçŠ¶æ€æ¢å¤**ï¼šè¿æ¥å¤±è´¥æ—¶é‡ç½®UIçŠ¶æ€

## ä¿®å¤æ•ˆæœå¯¹æ¯”

| å´©æºƒåœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|---------|--------|--------|
| æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯ | âŒ ç¨‹åºå´©æºƒ | âœ… æ˜¾ç¤º"å“åº”æ ¼å¼é”™è¯¯" |
| ç½‘ç»œè¿æ¥è¶…æ—¶ | âŒ ç¨‹åºæ— å“åº” | âœ… 30ç§’è¶…æ—¶+å‹å¥½æç¤º |
| RSAå¯†é’¥æ ¼å¼é”™è¯¯ | âŒ åŠ å¯†åº“å¼‚å¸¸ | âœ… æ˜¾ç¤º"å…¬é’¥æ ¼å¼æ— æ•ˆ" |
| æœåŠ¡å™¨æœªå“åº” | âŒ æ— é™ç­‰å¾… | âœ… è¶…æ—¶æ£€æµ‹+çŠ¶æ€é‡ç½® |
| è¿æ¥è¢«æ‹’ç» | âŒ æœªå¤„ç†å¼‚å¸¸ | âœ… æ˜ç¡®æç¤ºæ£€æŸ¥æœåŠ¡å™¨ |
| JSONè§£æå¤±è´¥ | âŒ ç¨‹åºå´©æºƒ | âœ… æ˜¾ç¤º"æ•°æ®æ ¼å¼é”™è¯¯" |

## é˜²å´©æºƒæœºåˆ¶æ€»ç»“

### ğŸ›¡ï¸ **å¤šå±‚é˜²æŠ¤**
1. **è¾“å…¥éªŒè¯å±‚**ï¼šæ£€æŸ¥æ‰€æœ‰è¾“å…¥æ•°æ®çš„æœ‰æ•ˆæ€§
2. **ç½‘ç»œæ“ä½œå±‚**ï¼šæ‰€æœ‰socketæ“ä½œéƒ½æœ‰å¼‚å¸¸å¤„ç†
3. **åè®®è§£æå±‚**ï¼šJSONè§£æå‰å…ˆéªŒè¯æ•°æ®ç±»å‹
4. **ä¸šåŠ¡é€»è¾‘å±‚**ï¼šå¯†é’¥æ“ä½œå‰æ£€æŸ¥å‰ç½®æ¡ä»¶
5. **èµ„æºç®¡ç†å±‚**ï¼šç¡®ä¿å¼‚å¸¸æ—¶æ­£ç¡®æ¸…ç†èµ„æº

### ğŸ” **é”™è¯¯è¯Šæ–­**
- **åˆ†ç±»é”™è¯¯æŠ¥å‘Š**ï¼šåŒºåˆ†ç½‘ç»œã€åè®®ã€åŠ å¯†ç­‰ä¸åŒç±»å‹é”™è¯¯
- **è¯¦ç»†é”™è¯¯ä¿¡æ¯**ï¼šæä¾›å…·ä½“çš„é”™è¯¯åŸå› å’Œå»ºè®®
- **çŠ¶æ€è·Ÿè¸ª**ï¼šåœ¨UIä¸­æ˜¾ç¤ºè¿æ¥è¿‡ç¨‹çš„è¯¦ç»†çŠ¶æ€
- **è°ƒè¯•ä¿¡æ¯**ï¼šä¾¿äºé—®é¢˜å®šä½å’Œè§£å†³

### âš¡ **æ€§èƒ½ä¼˜åŒ–**
- **åˆç†è¶…æ—¶è®¾ç½®**ï¼šé¿å…æ— é™ç­‰å¾…å¯¼è‡´UIå¡æ­»
- **é«˜æ•ˆé”™è¯¯å¤„ç†**ï¼šå¿«é€Ÿå¤±è´¥å¹¶æ¢å¤æ­£å¸¸çŠ¶æ€
- **èµ„æºåŠæ—¶é‡Šæ”¾**ï¼šé˜²æ­¢å†…å­˜æ³„æ¼å’Œèµ„æºå ç”¨

## æµ‹è¯•éªŒè¯

åˆ›å»ºäº†`test_connection_stability.py`æµ‹è¯•è„šæœ¬ï¼ŒéªŒè¯ï¼š
- âœ… å„ç§æœåŠ¡å™¨å“åº”æ ¼å¼çš„å¤„ç†
- âœ… ç½‘ç»œå¼‚å¸¸æƒ…å†µçš„å¤„ç†
- âœ… æ•°æ®éªŒè¯æœºåˆ¶çš„æœ‰æ•ˆæ€§
- âœ… å®Œæ•´è¿æ¥è¿‡ç¨‹çš„ç¨³å®šæ€§
- âœ… é”™è¯¯æ¢å¤æœºåˆ¶çš„æ­£ç¡®æ€§

---

**ä¿®å¤ç‰ˆæœ¬**ï¼šv2.0.1  
**ä¿®å¤çŠ¶æ€**ï¼šğŸ”’ å…¨é¢åŠ å›ºï¼Œé˜²å´©æºƒæœºåˆ¶å®Œå–„  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… é€šè¿‡æ‰€æœ‰ç¨³å®šæ€§æµ‹è¯•

ç°åœ¨æœåŠ¡å™¨éªŒè¯è¿‡ç¨‹å·²ç»å…·å¤‡å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œæ— è®ºé‡åˆ°ä»€ä¹ˆå¼‚å¸¸æƒ…å†µéƒ½ä¸ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œè€Œæ˜¯ä¼šæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚ 